# 网络配置分析的一般方法

## 背景
网络通过一系列路由器和交换机转发数据包. 每个设备的数据层状态决定了对于给定报头的数据包怎么被处理(例如呗丢弃或者是转发到特定的相邻节点). 这状态通常是由控制层生成的. 现在的网络通常是对设备进行配置(制定分组过滤的ACLs/直连预定IP的静态路由/使用一个或多个路由协议)来设定控制层. 所有设备的配置, 网络的拓扑结构以及相邻设备之间动态的信息交换一起组成了数据层. 

//由某个管理实体管理的网络被称为自治系统AS. 在AS内, 网络拓扑结构中的信息是通过诸如OSPF/BGP等的内部网关协议来交换的. 路由器根据数据包的前缀来指明目的IP. 本地策略则决定是否接受收到的数据包. 

在SDN模式中, 控制层是使用控制程序而非使用配置来决定. 但是作者觉得配置还是目前的主导且是很多时候产生错误的原因所在, 因此仍然专注于配置.

配置网络是艰巨的, 因为策略要求(资源管理/访问控制等)特别复杂, 而且配置的语言是很低级的. 错误非常常见. 常见的配置错误包含了可用性/安全性和性能问题. 


## 以前的方法

>1.分析配置文件
>
>这种静态分析方法可以在应用新配置之前发现错误, 对不同环境做出不同的分析.
>
>然而真实网络是复杂的且有很多的交互(如BGP/OSPF/ACL/VLAN/静态路由/路由重定向等), 现有的分析工具是对特定的配置开发特定的模型来应对这种复杂性. 例如RCC方法是生成配置的规范化表示, FIREMAN生成规则图来表示每个ACL并以此进行分析. 这种选择性聚焦确实可以用来分析网络配置, 但是也制约了分析的范围. 此外, 由于配置的其他很多方面都没有进行分析, 运营商很难去评估出发生的错误是否最终影响网络中数据包的转发
>
>2.分析网络的数据平面快照(转发行为)
>
>因为数据平面反应了所有配置的综合影响, 因此这种方法可以精确的检测出导致转发发生问题的任何配置错误. 数据平面的语义易于理解, 在各种逻辑结构中都可以有效地编码.
>
>但是在发生错误转发之前数据平面快照并不能主动的防治错误的发生. 一旦出现问题, 管理员仍然需要在本地配置中定位错误. 这通常是非常困难的, 因为并不一定是最近更改的配置导致发生了错误, 而错误的配置也可能在很久之后才会造成影响. 

## 本文提出的方法--Batfish

#### 概述
>静态地分析网络配置, 具有以上两种方法的优点.可以主动发现错误, 在不同环境中执行假设情况的分析; 可以容易地表达和检查大范围的正确属性, 并直接地估计出错误对转发的影响.
>
>导出了给定配置和环境下出现的实际的数据平面,如图1所示.(图1)

#### 可以做到
>通过从数据平面实际推导和分析, 可以做到:
>
>1.在应用配置之前就发现错误
>
>2.检查大量的转发属性, 且可以产生违反这些属性的实际数据包

#### 方法怎么实现
>需要为给定的配置和环境生成对应的数据平面
>
>必须平衡两个相互关联的问题
>
>必须是详细的和低层次的
>
>以产生一个准确的数据平面
>
>需要对构造以及相互作用进行推理, 涉及了大量的配置参数和指令. 同时需要提供一个高级视图来帮助分析, 让管理员了解发生的错误以及对应的配置片段.
>
>将网络配置和环境转换成了数据日志的变体, 使用这种语言来描述各种协议的行文. 执行得到的数据记录程序能产生表示数据平面的逻辑关系以及各种关键因素间的关系, 例如有特定协议下到目的地的最佳路由. 使用了自动约束求解器来检查最终数据平面的属性, 并生成没有这些属性的具体数据包. 最后这些数据包被反馈到声明的模型, 以此来确定更多的关系(如采用的路径沿途遇到ACL规则). 从这些可以得出发生的错误以及大致的位置.
>
>使用运算符可以查询到Batfish中任何正确的属性, 由此可以得出数据平面中关系的一阶逻辑公式. 及时没有管理员做任何输入Batfish也可以发现错误; 默认情况下该工具检查与转发一致的三个新的属性. 当存在多路径路由的时候, 数据流要么在所有路径上丢弃, 要么就沿着所有路径前往目的地. 

#### 描述
>采用了一组逻辑关系来表示控制平面/数据平面以及他们之间的关系
>
>通过运算符可以来查询这些关系, 来了解发生的错误以及对应的来源

>使用了该方法分析了两个不同路由设计的大型的大学网络, 发现了好多错误配置
>
>通过运算符确认了其中的大多数错误并对配置进行了相对应的修复.
>
>核心是低层次网络的高保真声明性模型
>
>功能不止用于检测配置错误, 还能提供迁移网络的迁移路径.

## 举个例子
考虑图2的网络N, 它有两个相邻的AS. P是一个大型网络供应商AS, C是拥有两个目的地前缀的客户AS. 路由N2直接连接到具有10.0.0.0/24前缀的内部私有网络. 为了让这个网络仅对于C是可用的, 因此需要作出相应的配置如图2下文字.

n1配置中的前两行制定在连接到n2和n3的两个接口上运行OSPF协议, 成本度量为1. 下两行指定了对于c2使用BGP协议, 且只接受如第三行所示前缀列表PLC的数据包.

n2也是差不多的配置, 多的是通过OSPF协议重新分布地连接网络.

n3则接受所有的前缀, 并用OSPF重新分配所有静态配置网络. 

通过这样的设置可以防止P和n4(及后面的主机)访问10.0.0.0/24, 且当有非法访问时管理员能够察觉.

这样是后面使用Batfish进行分析的实际的大型大学网络配置. 其中至少有两个错误:

1.n2中的PLC定义缺少了3.3.3.0/24, 因此n2将丢掉所有相关的包并且对于这个前缀没有任何连接. 应用配置是很难发现这个错误, 因为通过n1可以连接到. 只有当n1 c2或链路c2 n1都失败时才会发现到3.3.3.0/24的连接全部丢失. 缺乏了容错的能力以及负载均衡的能力

2.n2和n3将重新分配连接静态网络, n1将从两个相邻的节点得到到10.0.0.0/24的且成本相同的路径. 这就造成了默认情况就是多路径路由; n1将通过两个相邻节点向10.0.0.0/24发送数据包. 但是只有通过n2发送的数据包能到达目的地, 因为n3将丢弃这样的数据包. 这就造成了交通链路会经常间歇性重连. 

现有的方法不能在应用错误的网络配置之前发现这两种错误. 数据层分析可以发现数据包到不到达的问题但是无法发现第一种错误. 而静态分析方法(针对特定协议中的特定错误)则发现不了第二种错误, 因为这需要OSPF/连接路由/静态路由,以及通过这些的相互作用的精确模型. 

Batfish因为通过了1静态分析配置和2从配置中导出数据层的模型, 从而能发现提前发现这两种错误



## Batfish

### 在Batfish中实现的静态网络配置分析方法

图3展示了其工作流程的四个阶段

#### 从配置到数据层
前两个阶段将给定的网络配置转换成了具体的数据层. 

阶段1, 通过一个生成器将网络配置以及拓扑结构生成控制层的逻辑模型. 控制层的模型是用Datalog的变体--LogiQL(LogicBlox数据库引擎的语言). 除了最基本的Datalog, LogiQL还支持整数/算数运算符和聚合函数.

令作者们感觉棘手的是怎么将配置文件中的低级语言转换成高级的声明性语言. 控制层和最后的数据层模型的声明性质能提供一个简单的关系本体, 管理员可以用这个来了解错误的来源. 声明性语言显然比命令式代码更客观清晰.

图4是配置对应的控制层模型的一部分.  Part1 是对配置以及拓扑信息进行编码. 图中显示了于OSPF相关的一些信息, 如链路成本以及相邻节点.  Part2 是一组能获取任意网络控制层语义的一组规则. 如图中的OSPF路由的规则. 第一个是将最好的OSPF路由定义成最小成本的路由; 第二个通过简单的聚合运算找出OSPF路由中最小的成本来定义最小成本. 这两条规则用来实现最短路径计算. 


阶段2, 加入了环境作为附加输入, 因此这能进行不同情况的假设分析. 输入的环境信息包括了网络中每个链路的上行/下行状态等. 通过执行LogiQL程序(即数据层生成器)来将控制层模型和环境生成数据层模型. 所得到的数据层模型包含了各个路由器的转发行为(如丢弃还是转发给相邻节点), 以及各个规则中所使用的中间谓词, 因此用户能够简单的了解数据层各个组成的来源. 如Forward这个词能知道是来自OSPF.

于以前的静态分析技术不同, Batfish的前两个阶段分析了网络配置中与数据层相关的方方面面, 因此生成的数据层能准确的表达配置/拓扑结构和环境引起的转发行为.

#### 从数据层到配置错误
Batfish剩下的两个阶段是用来识别和定位配置错误. 

阶段3  分析一个或多个数据层来验证正确属性. 这一环节是通过检查表示为关系的一阶逻辑公式的属性进行. 将数据平面关系以及正确的属性通过Z3约束解算器来转换, 然后验证属性或者提供一个或多个反例. 除了用户指定的属性Batfish还能检查传统的可验证属性如是否有环路等. Batfish前两个阶段是与属性无关的所以可以生成需要用的数据层, 检查数据层上任意的属性而不用重新创建. 

阶段4  帮助管理员了解错误, 以便于修复网络配置. 通过在数据层模型上,用网络逻辑模拟反例数据包来进行. 在这个阶段会产生各种中间结果, 有些能直接向用户提供错误来源的信息如导致分组被丢弃的ACL的特定行. 对于之前举例的网络的第二个错误, Batfish能检测出多路径不一致的错误. 


## 评估
在两个使用不同设计的大型网络中使用, Net1和Net2. 

先分析Net1和Net2最新的网络配置. 正在稳定的工作但是存在管理员没有意识到的错误.

对于Net1, 使用了21个路由组成3层网络,3边界路由5核心路由和13个分布路由, 路由使用OSPF作为内部链接. 边界路由和分布路由则使用BGP. 他们设计的想法是每个部门的AS都希望与Net1核心网络有冗余的对等连接, 且每个部门拥有自己独立的地址空间. 供应商AS接受任意的数据包, 而部门AS则被配置为接受每个网络但是丢弃所有没分配到他们拥有的地址空间的数据包. 

Net2使用VLAN将网络分成两大层. 总共17个路由器3个是核心路由其他链接卫星校园.所有路由器运行OSPF实现内部链接.Net2没有使用BGP.

表1总结了发生的错误以及对应的数量. 网络中缺乏容错能力, 网络拓扑建模缺乏精确性. 


#### 分析 
Batfish去尝模拟配置中影响转发的所有方面, 不会产生假真或假伪.

但是还会有以下三种问题:

1. Batfish所有分析的基础都是路由器根据配置正常运行, 如果是路由器的硬件或者软件(BGP实现)发生了错误, 则这种错误无法发现. 

2. Batfish分析的是给定环境下的网络, 因此对于未提供的环境Batfish可能会无法检测某些错误. 

3. Batfish可能会遇到配置中当前仍未实现的功能, 有可能影响本地路由的选择. Batfish使用数据层作为中间表示, 因此可以通过向控制层模型添加逻辑规则来影响转发从未将当前未实现的功能加入模型中. 对于以前的工具来说, 对新功能重新建模和分析将是非常困难的.